<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pool Scout Pro - Pool Service Management</title>
    <link rel="stylesheet" href="/static/css/base.css?v=9">
    <link rel="stylesheet" href="/static/css/layout.css?v=9">
    <link rel="stylesheet" href="/static/css/components.css?v=9">
    <link rel="stylesheet" href="/static/css/modules.css?v=9">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Mobile Hamburger Button -->
    <button id="mobile-menu-toggle" class="mobile-menu-toggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Icon Sidebar -->
    <nav id="app-sidebar">
        <div class="sidebar-header">
            <div class="logo">PSP</div>
        </div>
        <ul class="sidebar-nav">
            <li>
                <a href="#dashboard" class="nav-item active" data-module="dashboard" title="Dashboard">
                    <i class="fas fa-chart-line"></i>
                    <span class="nav-label">Dashboard</span>
                </a>
            </li>
            <li>
                <a href="#team" class="nav-item" data-module="team" title="Team">
                    <i class="fas fa-users"></i>
                    <span class="nav-label">Team</span>
                </a>
            </li>
            <li>
                <a href="#clients" class="nav-item" data-module="clients" title="Clients">
                    <i class="fas fa-address-book"></i>
                    <span class="nav-label">Clients</span>
                </a>
            </li>
            <li>
                <a href="#routes" class="nav-item" data-module="routes" title="Routes">
                    <i class="fas fa-route"></i>
                    <span class="nav-label">Routes</span>
                </a>
            </li>
            <li>
                <a href="#jobs" class="nav-item" data-module="jobs" title="Jobs">
                    <i class="fas fa-clipboard-list"></i>
                    <span class="nav-label">Jobs</span>
                </a>
            </li>
            <li>
                <a href="#invoicing" class="nav-item" data-module="invoicing" title="Invoicing">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span class="nav-label">Invoicing</span>
                </a>
            </li>
        </ul>
        <ul class="sidebar-nav sidebar-bottom">
            <li>
                <a href="#settings" class="nav-item" data-module="settings" title="Settings">
                    <i class="fas fa-cog"></i>
                    <span class="nav-label">Settings</span>
                </a>
            </li>
            <li>
                <a href="#" class="nav-item" id="logout-btn" title="Logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="nav-label">Logout</span>
                </a>
            </li>
        </ul>
        <script>
            // Add logout functionality
            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault();
                if (confirm('Are you sure you want to logout?')) {
                    Auth.logout();
                }
            });
        </script>
        <button id="sidebar-toggle" class="sidebar-toggle" title="Toggle Sidebar">
            <i class="fas fa-bars"></i>
        </button>
    </nav>

    <!-- Main Content Area -->
    <main id="app-content">

        <!-- Dashboard Module -->
        <div id="module-dashboard" class="module-content active">
            <div class="page-header">
                <h1>Dashboard</h1>
            </div>
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <i class="fas fa-dollar-sign"></i>
                    <h3>Revenue</h3>
                    <p class="placeholder">Coming soon</p>
                </div>
                <div class="dashboard-card">
                    <i class="fas fa-users"></i>
                    <h3>Customers</h3>
                    <p class="placeholder">Coming soon</p>
                </div>
                <div class="dashboard-card">
                    <i class="fas fa-user-tie"></i>
                    <h3>Team Members</h3>
                    <p class="placeholder">Coming soon</p>
                </div>
                <div class="dashboard-card">
                    <i class="fas fa-route"></i>
                    <h3>Today's Routes</h3>
                    <p class="placeholder">Coming soon</p>
                </div>
            </div>
        </div>

        <!-- Team Module -->
        <div id="module-team" class="module-content" style="display: none;">
            <div class="page-header">
                <h1>Team Management</h1>
                <button id="add-tech-btn" class="btn-primary">+ Add Team Member</button>
            </div>
            <div class="team-filters">
                <input type="text" id="team-search" placeholder="Search team members..." class="search-input">
                <select id="team-status-filter" class="filter-select">
                    <option value="all">All Status</option>
                    <option value="active" selected>Active Only</option>
                    <option value="inactive">Inactive Only</option>
                </select>
                <select id="team-workload-filter" class="filter-select">
                    <option value="all">All Workload</option>
                    <option value="high">High (>30 customers)</option>
                    <option value="medium">Medium (15-30)</option>
                    <option value="low">Low (<15)</option>
                </select>
            </div>
            <div id="techs-content">
                <div id="techs-list" class="techs-grid">
                    <p class="placeholder">Loading techs...</p>
                </div>
            </div>
        </div>

        <!-- Clients Module -->
        <div id="module-clients" class="module-content" style="display: none;">
            <div class="page-header">
                <h1>Clients</h1>
                <div class="header-actions">
                    <button id="add-customer-btn" class="btn-primary">+ Add Customer</button>
                    <button id="bulk-edit-btn" class="btn-primary">Bulk Edit</button>
                </div>
            </div>
            <div class="clients-layout">
                <div class="clients-sidebar">
                    <div class="clients-sidebar-header">
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="clients-search" class="clients-search" placeholder="Search clients...">
                            <button id="clients-filter-btn" class="clients-filter-btn" title="Filter">
                                <i class="fas fa-filter"></i>
                            </button>
                        </div>
                        <div class="clients-quick-filter">
                            <button class="quick-filter-btn active" data-filter="all">All</button>
                            <button class="quick-filter-btn" data-filter="residential"><i class="fas fa-home"></i> Res</button>
                            <button class="quick-filter-btn" data-filter="commercial"><i class="fas fa-building"></i> Com</button>
                        </div>
                    </div>
                    <div id="customers-list">
                        <p class="placeholder">Loading clients...</p>
                    </div>
                </div>
                <div class="clients-detail">
                    <div class="clients-tabs">
                        <button class="tab-btn active" data-tab="profile">Profile</button>
                        <button class="tab-btn" data-tab="invoices">Invoices</button>
                    </div>
                    <div class="clients-tab-content">
                        <div id="tab-profile" class="tab-pane active">
                            <p class="placeholder">Select a client to view details</p>
                        </div>
                        <div id="tab-invoices" class="tab-pane">
                            <p class="placeholder">Invoice history will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Routes Module -->
        <div id="module-routes" class="module-content" style="display: none;">
            <div class="page-header">
                <h1>Routes</h1>
                <button id="optimize-btn" class="btn-primary">Optimize Routes</button>
            </div>

            <!-- Tech Selector -->
            <div class="tech-selector-container">
                <div class="tech-chips" id="tech-chips">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Day Selector -->
            <nav class="day-selector">
                <button class="day-tab" data-day="monday">Monday</button>
                <button class="day-tab" data-day="tuesday">Tuesday</button>
                <button class="day-tab" data-day="wednesday">Wednesday</button>
                <button class="day-tab" data-day="thursday">Thursday</button>
                <button class="day-tab" data-day="friday">Friday</button>
                <button class="day-tab" data-day="saturday">Saturday</button>
                <button class="day-tab" data-day="sunday">Sunday</button>
            </nav>

            <!-- Map and Routes Container -->
            <div class="map-routes-container">
                <!-- Map Container -->
                <section id="map-container">
                    <div id="map"></div>
                </section>

                <!-- Routes List -->
                <section id="routes-list">
                    <div id="routes-content">
                        <p class="placeholder">Select a day and click "Optimize Routes" to generate routes</p>
                    </div>
                </section>
            </div>
        </div>

        <!-- Jobs Module (Placeholder) -->
        <div id="module-jobs" class="module-content" style="display: none;">
            <div class="page-header">
                <h1>Job Tracking</h1>
            </div>
            <div class="placeholder-content">
                <i class="fas fa-clipboard-list"></i>
                <p>Job tracking module coming soon</p>
            </div>
        </div>

        <!-- Invoicing Module (Placeholder) -->
        <div id="module-invoicing" class="module-content" style="display: none;">
            <div class="page-header">
                <h1>Invoicing & Billing</h1>
            </div>
            <div class="placeholder-content">
                <i class="fas fa-file-invoice-dollar"></i>
                <p>Invoicing module coming soon</p>
            </div>
        </div>

        <!-- Settings Module (Placeholder) -->
        <div id="module-settings" class="module-content" style="display: none;">
            <div class="page-header">
                <h1>Settings</h1>
            </div>
            <div class="placeholder-content">
                <i class="fas fa-cog"></i>
                <p>Settings module coming soon</p>
            </div>
        </div>

    </main>

    <!-- Clients Filter Modal -->
    <div id="clients-filter-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>Filter Clients</h2>

            <div class="control-group">
                <label>Status:</label>
                <select id="filter-status">
                    <option value="active_pending">Active & Pending</option>
                    <option value="active">Active Only</option>
                    <option value="pending">Pending Only</option>
                    <option value="inactive">Inactive Only</option>
                    <option value="all">All Clients</option>
                </select>
            </div>

            <div class="control-group">
                <label>Service Day:</label>
                <select id="filter-service-day">
                    <option value="">All Days</option>
                    <option value="monday">Monday</option>
                    <option value="tuesday">Tuesday</option>
                    <option value="wednesday">Wednesday</option>
                    <option value="thursday">Thursday</option>
                    <option value="friday">Friday</option>
                    <option value="saturday">Saturday</option>
                    <option value="sunday">Sunday</option>
                </select>
            </div>

            <div class="control-group">
                <label>Assigned Tech:</label>
                <select id="filter-assigned-tech">
                    <option value="">All Techs</option>
                    <!-- Populated by JavaScript -->
                </select>
            </div>

            <div class="control-group">
                <label>Service Type:</label>
                <select id="filter-service-type">
                    <option value="">All Types</option>
                    <option value="residential">Residential</option>
                    <option value="commercial">Commercial</option>
                </select>
            </div>

            <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                <button id="apply-filter-btn" class="btn-primary">Apply Filter</button>
                <button id="clear-filter-btn" class="btn-secondary">Clear Filter</button>
            </div>
        </div>
    </div>

    <!-- Optimization Modal -->
    <div id="optimize-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>Route Optimization Settings</h2>

            <!-- Tech Selection -->
            <div class="control-group">
                <label>Select Techs:</label>
                <div id="opt-tech-selection" style="margin-top: 0.5rem; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 0.5rem; border-radius: 4px;">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Optimization Scope -->
            <div class="control-group">
                <label>Optimization Scope:</label>
                <div style="margin-top: 0.5rem;">
                    <label for="scope-day" style="display: block; margin-bottom: 0.5rem; cursor: pointer;">
                        <input type="radio" id="scope-day" name="optimization-scope" value="selected_day" checked>
                        Selected Day Only
                    </label>
                    <label for="scope-week" style="display: block; margin-bottom: 0.5rem; cursor: pointer;">
                        <input type="radio" id="scope-week" name="optimization-scope" value="entire_week">
                        Entire Week (Mon-Sat)
                    </label>
                </div>
            </div>

            <!-- Tech Assignment -->
            <div class="control-group" id="tech-assignment-section">
                <label>Tech Assignment:</label>
                <div style="margin-top: 0.5rem;">
                    <label for="mode-refine" style="display: block; margin-bottom: 0.5rem; cursor: pointer;">
                        <input type="radio" id="mode-refine" name="optimization-mode" value="refine" checked>
                        Keep Current Tech Assignments (optimize route order only)
                    </label>
                    <label for="mode-full" style="display: block; cursor: pointer;">
                        <input type="radio" id="mode-full" name="optimization-mode" value="full">
                        Allow Tech Reassignment (customers can move to different techs)
                    </label>
                </div>
            </div>

            <!-- Complete Rerouting Option -->
            <div class="control-group">
                <div style="border-top: 2px solid #e74c3c; margin: 1rem 0; padding-top: 1rem;">
                    <label for="scope-full" style="display: block; cursor: pointer; padding: 0.75rem; background: #fff3f3; border: 2px solid #e74c3c; border-radius: 4px;">
                        <input type="radio" id="scope-full" name="optimization-scope" value="complete_rerouting">
                        <strong style="color: #e74c3c;">Complete Rerouting (All Techs, All Days)</strong>
                        <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem; margin-left: 1.5rem;">
                            Full system redesign with optional day reassignment
                        </div>
                    </label>
                </div>
            </div>

            <!-- Customer Day Lock/Unlock List (only for Complete Rerouting) -->
            <div id="customer-lock-section" class="control-group" style="display: none;">
                <label>Customer Day Assignment:</label>
                <p style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">
                    ðŸ”“ Unlocked customers can move to different days. ðŸ”’ Locked customers stay on their current schedule.
                </p>
                <div style="margin-bottom: 0.5rem;">
                    <button type="button" id="lock-all-btn" class="btn-secondary" style="margin-right: 0.5rem;">ðŸ”’ Lock All</button>
                    <button type="button" id="unlock-all-btn" class="btn-secondary">ðŸ”“ Unlock All</button>
                </div>
                <div id="customer-lock-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 0.5rem; border-radius: 4px;">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Options -->
            <div class="control-group">
                <label>
                    <input type="checkbox" id="include-unassigned">
                    Include unassigned customers
                </label>
            </div>

            <div class="control-group">
                <label>
                    <input type="checkbox" id="include-pending">
                    Include pending customers
                </label>
            </div>

            <div class="control-group">
                <label>
                    <input type="checkbox" id="include-saturday">
                    Include Saturday (for complete rerouting)
                </label>
            </div>

            <div class="control-group">
                <label>
                    <input type="checkbox" id="include-sunday">
                    Include Sunday (for complete rerouting)
                </label>
            </div>

            <!-- Optimization Speed -->
            <div class="control-group">
                <label>Optimization Speed:</label>
                <div style="margin-top: 0.5rem;">
                    <label for="speed-quick" style="display: block; margin-bottom: 0.5rem; cursor: pointer;">
                        <input type="radio" id="speed-quick" name="optimization-speed" value="quick" checked>
                        Quick (30s, faster results)
                    </label>
                    <label for="speed-thorough" style="display: block; cursor: pointer;">
                        <input type="radio" id="speed-thorough" name="optimization-speed" value="thorough">
                        Thorough (120s, better optimization)
                    </label>
                </div>
            </div>

            <button id="run-optimize-btn" class="btn-primary">Run Optimization</button>
        </div>
    </div>

    <!-- Bulk Edit Modal -->
    <div id="bulk-edit-modal" class="modal">
        <div class="modal-content modal-large">
            <span class="modal-close">&times;</span>
            <h2>Bulk Edit Clients</h2>

            <div class="bulk-edit-toolbar">
                <div class="bulk-edit-actions">
                    <button id="save-bulk-changes-btn" class="btn-primary">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <button id="import-csv-btn" class="btn-secondary">
                        <i class="fas fa-upload"></i> Import CSV
                    </button>
                    <button id="download-template-btn" class="btn-secondary">
                        <i class="fas fa-download"></i> Download Template
                    </button>
                    <button id="export-csv-btn" class="btn-secondary">
                        <i class="fas fa-file-csv"></i> Export CSV
                    </button>
                </div>
                <div class="bulk-edit-info">
                    <span id="bulk-edit-count">0 clients loaded</span>
                </div>
            </div>

            <div class="bulk-edit-table-container">
                <table id="bulk-edit-table" class="bulk-edit-table">
                    <thead>
                        <tr>
                            <th class="frozen-col">Display Name</th>
                            <th>Type</th>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Street Address</th>
                            <th>City</th>
                            <th>State</th>
                            <th>ZIP</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Alt Email</th>
                            <th>Alt Phone</th>
                            <th>Invoice Email</th>
                            <th>Mgmt</th>
                            <th>Assigned Tech</th>
                            <th>Service Day</th>
                            <th>Dys/Wk</th>
                            <th>Mins</th>
                            <th>Diff</th>
                            <th>Lock</th>
                        </tr>
                    </thead>
                    <tbody id="bulk-edit-tbody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Change Tech Modal -->
    <div id="change-tech-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>Change Tech Assignment</h2>
            <p id="change-tech-customer-name" style="color: #666; margin-bottom: 1rem;"></p>

            <div class="control-group">
                <label>Assign To:</label>
                <select id="change-tech-select">
                    <option value="">Select Tech...</option>
                </select>
            </div>

            <div class="control-group">
                <label>Assignment Type:</label>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <label style="cursor: pointer;">
                        <input type="radio" name="assignment-type" value="temporary" checked>
                        One-time only (for today's routes only)
                    </label>
                    <label style="cursor: pointer;">
                        <input type="radio" name="assignment-type" value="permanent">
                        Permanent (update customer record in database)
                    </label>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button id="apply-tech-change-btn" class="btn-primary">Apply Change</button>
                <button class="btn-secondary" onclick="closeModal('change-tech-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Hidden file input for CSV import -->
    <input type="file" id="csv-file-input" accept=".csv" style="display: none;">

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Authentication (must load first) -->
    <script src="/static/js/auth.js"></script>
    <script>
        // Check authentication before loading the app
        Auth.requireAuth();
    </script>
    <!-- Utilities (no dependencies - load first) -->
    <script src="/static/js/utils/helpers.js"></script>
    <!-- Feature modules (must load before app.js) -->
    <script src="/static/js/modules/navigation.js"></script>
    <script src="/static/js/modules/map.js"></script>
    <script src="/static/js/modules/modals.js"></script>
    <script src="/static/js/modules/techs.js"></script>
    <script src="/static/js/modules/routes.js"></script>
    <script src="/static/js/modules/customers.js"></script>
    <script src="/static/js/modules/bulk-edit.js"></script>
    <!-- Main application -->
    <script src="/static/js/app.js"></script>
</body>
</html>
